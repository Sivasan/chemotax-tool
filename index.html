<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genome-resolved Chemotaxonomy</title>
    <!-- Load Tailwind CSS -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <!-- Icons -->
    <script type="module" src="[https://unpkg.com/lucide-react@latest/dist/esm/lucide-react.js](https://unpkg.com/lucide-react@latest/dist/esm/lucide-react.js)"></script>
    <script nomodule src="[https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js](https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js)"></script>
    <style>
        /* Simple spinner animation */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border-left-color: #0ea5e9;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-full font-sans antialiased text-gray-900">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-2">
                        <!-- Simple DNA Icon -->
                        <svg class="w-8 h-8 text-sky-600" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-2ZM8 11a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-5ZM12 8a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1V8ZM16 5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1V5Z"/></svg>
                        <h1 class="text-2xl font-bold text-gray-800">Chemotaxonomy Tool</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">

                <!-- Left Column: Upload & Options -->
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700">1. Upload Annotation Files</h2>
                    <!-- File list container -->
                    <div id="file-list" class="space-y-4">
                        <!-- File rows will be injected here by JS -->
                    </div>
                    <button id="add-file-btn" type="button" class="w-full flex justify-center items-center space-x-2 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        <svg class="w-5 h-5" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Add Another File</span>
                    </button>

                    <h2 class="text-xl font-semibold text-gray-700 pt-4">2. Options</h2>
                    <div>
                        <label for="phylum-input" class="block text-sm font-medium text-gray-700">Target Phylum (Optional)</label>
                        <input type="text" id="phylum-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="e.g., Actinobacteria, Firmicutes">
                        <p class="mt-2 text-xs text-gray-500">Comma-separated. Restricts search to markers relevant to these taxa.</p>
                    </div>

                    <h2 class="text-xl font-semibold text-gray-700 pt-4">3. Run Analysis</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="analyze-btn" type="button" class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                            <span class="spinner hidden mr-2"></span>
                            <span>Analyze (View JSON)</span>
                        </button>
                        <button id="report-btn" type="button" class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-gray-300 rounded-md shadow-sm text-base font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                            <span class="spinner hidden mr-2"></span>
                            <span>Download Report (.md)</span>
                        </button>
                    </div>
                </div>

                <!-- Right Column: Results -->
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700">Results</h2>
                    <!-- Message/Error Box -->
                    <div id="message-box" class="hidden p-4 rounded-md"></div>
                    
                    <!-- JSON Output Area -->
                    <div class="bg-gray-900 rounded-md shadow-sm overflow-hidden">
                        <div class="px-4 py-2 bg-gray-800 text-xs font-mono text-gray-400">
                            JSON Output
                        </div>
                        <pre id="json-output" class="p-4 text-xs text-green-300 font-mono overflow-x-auto h-96">Awaiting analysis...</pre>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-12">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="py-4 text-center text-sm text-gray-500">
                    Chemotaxonomy Tool
                </div>
            </div>
        </footer>
    </div>

    <!-- File Row Template -->
    <template id="file-row-template">
        <div class="file-row p-4 border border-gray-200 rounded-md bg-white shadow-sm">
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <div class="flex-grow mb-2 sm:mb-0">
                    <label class="block text-sm font-medium text-gray-700 sr-only">File</label>
                    <input type="file" class="file-input block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-sky-50 file:text-sky-700
                        hover:file:bg-sky-100" required>
                </div>
                <div class="flex-shrink-0">
                    <label class="block text-sm font-medium text-gray-700 sr-only">Format</label>
                    <select class="format-select mt-1 block w-full sm:w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md" required>
                        <option value="">Select format...</option>
                        <option value="gff3">GFF3 (generic)</option>
                        <option value="prokka">Prokka (.gff)</option>
                        <option value="bakta">Bakta (.gff3 or .tsv)</option>
                        <option value="rast">RAST (.tsv)</option>
                        <option value="dram">DRAM (.tsv)</option>
                        <option value="gbk">GenBank (.gbk)</option>
                        <option value="hmm">HMMER (domtblout)</option>
                        <option value="tsv">Generic TSV</option>
                    </select>
                </div>
                <div class="flex-shrink-0 mt-2 sm:mt-0">
                    <button type="button" class="remove-file-btn p-2 text-gray-400 hover:text-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                        <svg class="w-5 h-5" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002 2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileList = document.getElementById('file-list');
            const addFileBtn = document.getElementById('add-file-btn');
            const fileRowTemplate = document.getElementById('file-row-template');
            
            const phylumInput = document.getElementById('phylum-input');
            const analyzeBtn = document.getElementById('analyze-btn');
            const reportBtn = document.getElementById('report-btn');
            
            const messageBox = document.getElementById('message-box');
            const jsonOutput = document.getElementById('json-output');

            // --- Config ---
            // The API_BASE_URL is now just a relative path ('')
            // because the HTML page and the API are served from the SAME server.
            const API_BASE_URL = ''; 
            // --- End Config ---

            const addNewFileRow = () => {
                const clone = fileRowTemplate.content.cloneNode(true);
                const fileRow = clone.querySelector('.file-row');
                const removeBtn = clone.querySelector('.remove-file-btn');
                
                removeBtn.addEventListener('click', () => {
                    fileRow.remove();
                    updateRemoveButtonVisibility();
                });
                
                fileList.appendChild(clone);
                updateRemoveButtonVisibility();
            };

            const updateRemoveButtonVisibility = () => {
                const rows = fileList.querySelectorAll('.file-row');
                rows.forEach((row, index) => {
                    const removeBtn = row.querySelector('.remove-file-btn');
                    if (index === 0 && rows.length === 1) {
                        removeBtn.classList.add('hidden'); // Hide remove button if only one row
                    } else {
                        removeBtn.classList.remove('hidden');
                    }
                });
            };

            const showMessage = (message, type = 'error') => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                }
                // Scroll to message
                messageBox.scrollIntoView({ behavior: 'smooth' });
            };

            const hideMessage = () => {
                messageBox.classList.add('hidden');
                messageBox.textContent = '';
            };

            const setButtonsLoading = (isLoading) => {
                const buttons = [analyzeBtn, reportBtn];
                buttons.forEach(btn => {
                    const spinner = btn.querySelector('.spinner');
                    if (isLoading) {
                        btn.disabled = true;
                        btn.classList.add('opacity-75', 'cursor-not-allowed');
                        spinner.classList.remove('hidden');
                    } else {
                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        spinner.classList.add('hidden');
                    }
                });
            };

            const buildFormData = () => {
                const formData = new FormData();
                const fileRows = fileList.querySelectorAll('.file-row');
                let fileCount = 0;
                
                for (const row of fileRows) {
                    const fileInput = row.querySelector('.file-input');
                    const formatSelect = row.querySelector('.format-select');
                    
                    if (fileInput.files.length > 0 && formatSelect.value) {
                        formData.append('files', fileInput.files[0]);
                        formData.append('formats', formatSelect.value);
                        fileCount++;
                    } else if (fileInput.files.length > 0 && !formatSelect.value) {
                        throw new Error(`Please select a format for the file: ${fileInput.files[0].name}`);
                    }
                }

                if (fileCount === 0) {
                    throw new Error('Please add at least one file and select its format.');
                }
                
                const phylum = phylumInput.value.trim();
                if (phylum) {
                    formData.append('phylum', phylum);
                }
                
                return formData;
            };

            const handleAnalyze = async () => {
                hideMessage();
                setButtonsLoading(true);
                jsonOutput.textContent = 'Analyzing...';
                jsonOutput.classList.remove('text-green-300', 'text-red-300');
                
                try {
                    const formData = buildFormData();
                    // The path is now relative to the current page.
                    // e.g., 'api/analyze-multi'
                    const response = await fetch(`${API_BASE_URL}api/analyze-multi`, {
                        method: 'POST',
                        body: formData,
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || `Server error: ${response.status}`);
                    }
                    
                    jsonOutput.textContent = JSON.stringify(result, null, 2);
                    jsonOutput.classList.add('text-green-300');
                    showMessage('Analysis complete!', 'success');
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    showMessage(`Analysis failed: ${error.message}`, 'error');
                    jsonOutput.textContent = `Error: ${error.message}`;
                    jsonOutput.classList.add('text-red-300');
                } finally {
                    setButtonsLoading(false);
                }
            };
            
            const handleReport = async () => {
                hideMessage();
                setButtonsLoading(true);

                try {
                    const formData = buildFormData();
                    // The path is now relative to the current page.
                    // e.g., 'api/analyze-and-report'
                    const response = await fetch(`${API_BASE_URL}api/analyze-and-report`, {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (!response.ok) {
                        // Try to parse error JSON
                        let errorMsg = `Server error: ${response.status}`;
                        try {
                            const errResult = await response.json();
                            errorMsg = errResult.error || errorMsg;
                        } catch (e) { /* Not a JSON error */ }
                        throw new Error(errorMsg);
                    }
                    
                    // Get filename from Content-Disposition header
                    const disposition = response.headers.get('content-disposition');
                    let filename = 'chemotax_report.md';
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }

                    const blob = await response.blob();
                    
                    // Create a link to download the file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
    
                    a.remove();
                    
                    showMessage('Report download started.', 'success');
                    
                } catch (error) {
                    console.error('Report error:', error);
                    showMessage(`Report failed: ${error.message}`, 'error');
                } finally {
                    setButtonsLoading(false);
                }
            };

            // Add event listeners
            addFileBtn.addEventListener('click', addNewFileRow);
            analyzeBtn.addEventListener('click', handleAnalyze);
            reportBtn.addEventListener('click', handleReport);

            // Add the first file row on load
            addNewFileRow();
        });
    </script>
</body>
</html>
